# 简介

本手册将对以下的问题进行讨论：

1. 编写、编译、烧写以及调试 Rust 嵌入式程序；
2. 访问通用外设：GPIO、ADC、PWM、I2C、SPI等；
3. 实时系统的进程调度；

在阅读本手册时，推荐你准备下面的东西：

1. STM32F4 系列开发板
2. 对应芯片的参考手册

## STM32 微处理器基础

Cortex-M4 基于3级流水线哈佛架构，部分处理器集成了 FPU 浮点处理单元，SIMD乘法以及乘累加能力，饱和运算和专用硬件部门。

我们需要重点理解和掌握的是 Cortex-M4 处理器的中断处理。ARM Cortex-M4 的中断向量表中包含下面的内容。

1. 初始堆栈指针
2. 15个内核中断处理函数指针
3. 97个外部中断处理函数指针

### 启动过程分析

STM32系列处理器可以通过配置 BOOT\[1:0\] ，选择下面 3 中启动模式的一种。

| BOOT1 | BOOT0 | 启动区域 | 说明 |
| :--- | :--- | :--- | :--- |
| X | 0 | 主闪存存储器 | 主闪存存储器为启动区域 |
| 0 | 1 | 系统存储器 | 系统存储器为启动区域 |
| 1 | 1 | 内置SRAM | 内置SRAM为启动区域 |

上面的三种启动模式中，

### 内核异常及中断

以STM32 - F446RE 为例，其包含9个内核异常和96个可屏蔽中断通道，列表如下：

| 位置 | 优先级 | 优先级类型 | 缩写 | 说明 | 地址 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| \ | \ | \ | \ | 保留 | 0x0000 0000 |
|  | -3 | 固定 | Reset | 复位 | 0x0000 0004 |
|  | -2 | 固定 | NMI | 不可屏蔽中断。 | 0x0000 0008 |
|  | -1 | 固定 | HardFault | 所有类型的故障 | 0x0000 000C |
|  | 0 | 可设置 | MemManage | 存储器管理 | 0x0000 0010 |
|  | 1 | 可设置 | BusFault | 预取故障、存储访问失败 | 0x0000 0014 |
|  | 2 | 可设置 | UsageFault | 未定义的指令或非法故障 | 0x0000 0018 |
| \ | \ | \ | \ | 保留 | 0x0000 001C |
| \ | \ | \ | \ | 保留 | 0x0000 0020 |
| \ | \ | \ | \ | 保留 | 0x0000 0024 |
| \ | \ | \ | \ | 保留 | 0x0000 0028 |
| \ | 3 | 可设置 | SVCall | 通过 SWI 指令调用系统服务 | 0x0000 002C |
|  | 4 | 可设置 | Debug Monitor | 调试监控器 | 0x0000 0030 |
| \ | \ | \ | \ | 保留 | 0x0000 0034 |
|  | 5 | 可设置 | PendSV | 可挂起的系统服务？ | 0x0000 0038 |
|  | 6 | 可设置 | SysTick | 系统嘀嗒定时器 | 0x000 0003C |

### 链接器脚本



## 环境配置

#### 安装 Rust

```
curl https://sh.rustup.rs -sSf | sh
```

#### 安装 ARM-GCC

```
brew cask install gcc-arm-embedded openocd qemu
```

 

## 第一个程序

在编写第一个程序之前，需要对下面的内容进行讲解。

1. 程序从源代码编译为可运行代码经过的过程，编译——链接
2. Rust 如何指定链接器
3. 链接器脚本的编写；

在 Rust 中，可以通过 cargo 配置来指定链接时使用的链接器，当前我们仍然需要使用 gcc-ld 来进行链接工作。

链接器所进行的工作是将

